# ============================================================
# EduPortal - Rollback Workflow
# ============================================================
# Triggers on: Manual dispatch only
# Jobs: Rollback to previous version
# ============================================================

name: Rollback Deployment

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to rollback'
        required: true
        type: choice
        options:
          - test
          - production
      version:
        description: 'Version to rollback to (e.g., v1.0.0 or prod-20240101-abc1234)'
        required: false
        default: ''
      reason:
        description: 'Reason for rollback'
        required: true
        type: string

env:
  IMAGE_NAME: ${{ secrets.DOCKERHUB_USERNAME }}/eduportal-api

jobs:
  # ===========================================================
  # Validate Rollback Request
  # ===========================================================
  validate:
    name: Validate Rollback
    runs-on: ubuntu-latest
    outputs:
      target-image: ${{ steps.validate.outputs.target_image }}

    steps:
      - name: Validate inputs
        id: validate
        run: |
          echo "## üîÑ Rollback Request" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ github.event.inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ github.event.inputs.version || 'previous' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Reason:** ${{ github.event.inputs.reason }}" >> $GITHUB_STEP_SUMMARY
          echo "**Requested by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Determine target image
          VERSION="${{ github.event.inputs.version }}"
          ENV="${{ github.event.inputs.environment }}"

          if [ -n "$VERSION" ]; then
            TARGET_IMAGE="${{ env.IMAGE_NAME }}:$VERSION"
          else
            if [ "$ENV" = "production" ]; then
              TARGET_IMAGE="${{ env.IMAGE_NAME }}:prod-previous"
            else
              TARGET_IMAGE="${{ env.IMAGE_NAME }}:test-previous"
            fi
          fi

          echo "target_image=$TARGET_IMAGE" >> $GITHUB_OUTPUT
          echo "Target image: $TARGET_IMAGE"

  # ===========================================================
  # Rollback Test Environment
  # ===========================================================
  rollback-test:
    name: Rollback Test
    runs-on: ubuntu-latest
    needs: validate
    if: github.event.inputs.environment == 'test'
    environment: test

    steps:
      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.TEST_SERVER_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.TEST_SERVER_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Perform rollback
        env:
          SSH_KEY: ~/.ssh/deploy_key
          SERVER_HOST: ${{ secrets.TEST_SERVER_HOST }}
          SERVER_USER: ${{ secrets.TEST_SERVER_USER }}
          TARGET_VERSION: ${{ github.event.inputs.version }}
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
        run: |
          ssh -i $SSH_KEY -o StrictHostKeyChecking=no ${SERVER_USER}@${SERVER_HOST} << 'ENDSSH'
            set -e

            echo "========================================"
            echo "üîÑ Rolling back TEST environment"
            echo "========================================"

            cd /opt/eduportal || exit 1

            # Determine target image
            if [ -n "$TARGET_VERSION" ]; then
              TARGET_IMAGE="${DOCKERHUB_USERNAME}/eduportal-api:$TARGET_VERSION"
            else
              # Get previous image from backup
              PREV_IMAGE=$(cat /opt/eduportal/backups/*/previous_image.txt 2>/dev/null | tail -1)
              if [ -z "$PREV_IMAGE" ]; then
                echo "‚ùå No previous image found!"
                exit 1
              fi
              TARGET_IMAGE="$PREV_IMAGE"
            fi

            echo "Rolling back to: $TARGET_IMAGE"

            # Pull target image
            echo "[1/4] Pulling target image..."
            docker pull $TARGET_IMAGE || {
              echo "‚ùå Failed to pull image: $TARGET_IMAGE"
              exit 1
            }

            # Stop current container
            echo "[2/4] Stopping current container..."
            docker-compose -f docker-compose.test.yml --env-file .env.test down

            # Tag as latest for compose
            echo "[3/4] Starting rolled-back version..."
            docker tag $TARGET_IMAGE ${DOCKERHUB_USERNAME}/eduportal-api:latest
            docker-compose -f docker-compose.test.yml --env-file .env.test up -d

            # Health check
            echo "[4/4] Verifying rollback..."
            sleep 15
            HEALTH_STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8080/health || echo "000")

            if [ "$HEALTH_STATUS" = "200" ]; then
              echo "‚úÖ Rollback successful!"
            else
              echo "‚ùå Health check failed after rollback!"
              exit 1
            fi

            echo "========================================"
            echo "‚úÖ TEST Rollback Complete"
            echo "========================================"
          ENDSSH

      - name: Rollback Summary
        run: |
          echo "## ‚úÖ TEST Rollback Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Rolled back to:** ${{ github.event.inputs.version || 'previous version' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Reason:** ${{ github.event.inputs.reason }}" >> $GITHUB_STEP_SUMMARY
          echo "**Completed at:** $(date -u)" >> $GITHUB_STEP_SUMMARY

  # ===========================================================
  # Rollback Production Environment
  # ===========================================================
  rollback-production:
    name: Rollback Production
    runs-on: ubuntu-latest
    needs: validate
    if: github.event.inputs.environment == 'production'
    environment:
      name: production

    steps:
      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.PROD_SERVER_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.PROD_SERVER_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Perform rollback
        env:
          SSH_KEY: ~/.ssh/deploy_key
          SERVER_HOST: ${{ secrets.PROD_SERVER_HOST }}
          SERVER_USER: ${{ secrets.PROD_SERVER_USER }}
          TARGET_VERSION: ${{ github.event.inputs.version }}
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
        run: |
          ssh -i $SSH_KEY -o StrictHostKeyChecking=no ${SERVER_USER}@${SERVER_HOST} << 'ENDSSH'
            set -e

            echo "========================================"
            echo "üîÑ Rolling back PRODUCTION environment"
            echo "========================================"

            cd /opt/eduportal || exit 1

            # Determine target image
            if [ -n "$TARGET_VERSION" ]; then
              TARGET_IMAGE="${DOCKERHUB_USERNAME}/eduportal-api:$TARGET_VERSION"
            else
              # Get previous image from backup
              BACKUP_DIR=$(ls -td /opt/eduportal/backups/*/ 2>/dev/null | head -1)
              if [ -n "$BACKUP_DIR" ] && [ -f "${BACKUP_DIR}previous_image.txt" ]; then
                PREV_IMAGE=$(cat "${BACKUP_DIR}previous_image.txt")
              fi

              if [ -z "$PREV_IMAGE" ]; then
                echo "‚ùå No previous image found!"
                exit 1
              fi
              TARGET_IMAGE="$PREV_IMAGE"
            fi

            echo "Rolling back to: $TARGET_IMAGE"

            # Create rollback backup
            ROLLBACK_BACKUP="/opt/eduportal/backups/rollback_$(date +'%Y%m%d_%H%M%S')"
            mkdir -p $ROLLBACK_BACKUP
            docker inspect eduportal-api-prod --format='{{.Config.Image}}' > $ROLLBACK_BACKUP/pre_rollback_image.txt 2>/dev/null || true

            # Pull target image
            echo "[1/5] Pulling target image..."
            docker pull $TARGET_IMAGE || {
              echo "‚ùå Failed to pull image: $TARGET_IMAGE"
              exit 1
            }

            # Stop current container
            echo "[2/5] Stopping current container..."
            docker-compose -f docker-compose.prod.yml --env-file .env.prod stop api-prod

            # Tag as prod-latest for compose
            echo "[3/5] Tagging rolled-back version..."
            docker tag $TARGET_IMAGE ${DOCKERHUB_USERNAME}/eduportal-api:prod-latest

            # Start rolled-back version
            echo "[4/5] Starting rolled-back version..."
            docker-compose -f docker-compose.prod.yml --env-file .env.prod up -d api-prod

            # Health check with retries
            echo "[5/5] Verifying rollback..."
            MAX_RETRIES=10
            RETRY_COUNT=0

            while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
              sleep 5
              HEALTH_STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8081/health || echo "000")

              if [ "$HEALTH_STATUS" = "200" ]; then
                echo "‚úÖ Rollback successful! Health check passed."
                exit 0
              fi

              RETRY_COUNT=$((RETRY_COUNT + 1))
              echo "Health check attempt $RETRY_COUNT/$MAX_RETRIES - Status: $HEALTH_STATUS"
            done

            echo "‚ùå Health check failed after rollback!"
            exit 1
          ENDSSH

      - name: Rollback Summary
        run: |
          echo "## ‚úÖ PRODUCTION Rollback Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Rolled back to:** ${{ github.event.inputs.version || 'previous version' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Reason:** ${{ github.event.inputs.reason }}" >> $GITHUB_STEP_SUMMARY
          echo "**Completed by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Completed at:** $(date -u)" >> $GITHUB_STEP_SUMMARY

  # ===========================================================
  # Notify
  # ===========================================================
  notify:
    name: Send Notification
    runs-on: ubuntu-latest
    needs: [validate, rollback-test, rollback-production]
    if: always()

    steps:
      - name: Send Slack notification
        if: ${{ secrets.SLACK_WEBHOOK_URL != '' }}
        uses: 8398a7/action-slack@v3
        with:
          status: custom
          custom_payload: |
            {
              "attachments": [{
                "color": "warning",
                "title": "‚ö†Ô∏è EduPortal Rollback Executed",
                "fields": [
                  {
                    "title": "Environment",
                    "value": "${{ github.event.inputs.environment }}",
                    "short": true
                  },
                  {
                    "title": "Version",
                    "value": "${{ github.event.inputs.version || 'previous' }}",
                    "short": true
                  },
                  {
                    "title": "Reason",
                    "value": "${{ github.event.inputs.reason }}",
                    "short": false
                  },
                  {
                    "title": "Executed by",
                    "value": "${{ github.actor }}",
                    "short": true
                  }
                ],
                "footer": "GitHub Actions - Rollback"
              }]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
