name: Deploy to Production

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy and Migrate via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e
            cd /opt/eduportal

            echo "üì• Pulling latest code..."
            if [ -d ".git" ]; then
              git pull origin main
            else
              git clone https://github.com/nowoterra-oss/EducationPortal.git .
            fi

            echo "üîß Creating environment file..."
            cat > .env.prod << 'ENVEOF'
            DB_HOST=mssql-prod
            DB_PORT=1433
            DB_NAME=EduPortalDb_Prod
            DB_USER=${{ secrets.DB_USER_PROD }}
            DB_PASSWORD=${{ secrets.DB_PASSWORD_PROD }}
            JWT_KEY=${{ secrets.JWT_KEY }}
            JWT_ISSUER=EduPortalAPI
            JWT_AUDIENCE=EduPortalClient
            ENVEOF

            echo "üóÑÔ∏è Running database migration..."
            # Migration'ƒ± ge√ßici bir container'da √ßalƒ±≈ütƒ±r (mssql-prod'a localhost √ºzerinden eri≈üebilir)
            docker run --rm \
              --network host \
              -v $(pwd):/app \
              -w /app \
              -e ConnectionStrings__ConnectionString="Server=127.0.0.1,1433;Database=EduPortalDb_Prod;User Id=${{ secrets.DB_USER_PROD }};Password=${{ secrets.DB_PASSWORD_PROD }};Encrypt=True;TrustServerCertificate=True;MultipleActiveResultSets=True" \
              mcr.microsoft.com/dotnet/sdk:8.0 \
              bash -c "dotnet tool install --global dotnet-ef && export PATH=\"\$PATH:/root/.dotnet/tools\" && dotnet ef database update --project src/EduPortal.Infrastructure/EduPortal.Infrastructure.csproj --startup-project src/EduPortal.API/EduPortal.API.csproj --verbose"

            echo "üê≥ Deploying with Docker Compose..."
            docker compose -f docker-compose.prod.yml --env-file .env.prod down || true
            docker compose -f docker-compose.prod.yml --env-file .env.prod up -d --build

            # Network'e baƒüla
            docker network connect nwtsoft-network eduportal-api-prod 2>/dev/null || true

            echo "‚è≥ Waiting for services to start..."
            sleep 30

            echo "üè• Running health check..."
            curl -f http://127.0.0.1:8080/health && echo "‚úÖ Prod Deployment successful!" || echo "‚ö†Ô∏è Health check failed"
